// Solo la función createChatSession correcta
export const createChatSession = (name: string, country: string, age: string) => {
  const systemInstruction = `Eres Santa Claus/Papá Noel. IMPORTANTE: Debes responder SIEMPRE en español, sin importar el idioma en que te escriban. Estás hablando con un niño/a llamado/a ${name} de ${country} que tiene ${age} años. Sé cálido, amigable, y pregúntales qué quieren para Navidad. Mantén las respuestas relativamente cortas. Usa expresiones navideñas como "Ho ho ho!".`;
  const history: any[] = [];

  return {
    sendMessage: async (userMessage: any) => {
      let conversationContext = systemInstruction;

      if (history.length > 0) {
        const conversationHistory = history.map((msg: any) => {
          if (msg.role === 'user') {
            return `User: ${msg.text}`;
          } else {
            return `Assistant: ${msg.text}`;
          }
        }).join('\n');

        conversationContext = `${systemInstruction}\n\n${conversationHistory}`;
      }

      const fullPrompt = `${conversationContext}\n\nUser: ${userMessage.parts[0].text}\nAssistant:`;

      const response = await ai.models.generateContent({
        model: 'gemini-2.0-flash-exp',
        contents: [
          {
            role: 'user',
            parts: [{ text: fullPrompt }]
          }
        ]
      });

      const responseText = response.text || '';

      history.push({ role: 'user', text: userMessage.parts[0].text });
      history.push({ role: 'model', text: responseText });

      return { text: responseText };
    }
  };
};
